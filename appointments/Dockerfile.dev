FROM maven:3.9-eclipse-temurin-17
WORKDIR /app

# Install curl and netcat for healthchecks
RUN apt-get update && apt-get install -y curl netcat-openbsd

# Copy the POM file first to leverage Docker cache
COPY pom.xml .
# Copy the source code
COPY src ./src

# Environment variables for Spring
ENV SPRING_PROFILES_ACTIVE=dev

# Optimized JVM settings for development
ENV JAVA_OPTS="-Xms256m -Xmx512m -XX:+UseG1GC -Djava.security.egd=file:/dev/./urandom"

# Expose the application port
EXPOSE 8080

# Set an entrypoint to run the application with spring-boot:run for hot reloading
ENTRYPOINT ["/bin/sh", "-c", "while ! nc -z db 5432; do echo 'Waiting for database to be available...'; sleep 1; done; echo 'Database is available, starting application in development mode...'; mvn spring-boot:run -Dspring-boot.run.jvmArguments=\"$JAVA_OPTS\""]
